<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delightful Deploy - ìƒˆ ë°°í¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .step-indicator {
            position: relative;
            display: flex;
            align-items: center;
        }

        .step-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
            transform: translateY(-50%);
        }

        .step-item {
            position: relative;
            z-index: 1;
            background: white;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-item.completed {
            background: #10b981;
            color: white;
        }

        .step-item.active {
            background: #667eea;
            color: white;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            animation: pulse-glow 2s infinite;
        }

        .step-item.pending {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .step-item.error {
            background: #ef4444;
            color: white;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
            }
        }

        .log-console {
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 16px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-line {
            margin-bottom: 4px;
            white-space: pre-wrap;
        }

        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .deploy-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .deploy-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE_URL = window.location.origin;

        // ë°°í¬ ë‹¨ê³„ ì •ì˜
        const DEPLOY_STEPS = [
            { id: 1, name: 'Git Push', description: 'Repositoryì— ì½”ë“œ í‘¸ì‹œ', icon: 'ğŸ“¤' },
            { id: 2, name: 'AI ë¶„ì„', description: 'AIê°€ í”„ë¡œì íŠ¸ ì½”ë“œ ë¶„ì„', icon: 'ğŸ¤–' },
            { id: 3, name: 'í”„ë¡œì íŠ¸ ê°ì§€', description: 'í”„ë ˆì„ì›Œí¬ ë° ì˜ì¡´ì„± ê°ì§€', icon: 'ğŸ”' },
            { id: 4, name: 'ì„¤ì • ìƒì„±', description: 'Dockerfile ìë™ ìƒì„±', icon: 'ğŸ“' },
            { id: 5, name: 'Docker ë¹Œë“œ', description: 'Docker ì´ë¯¸ì§€ ë¹Œë“œ', icon: 'ğŸ³' },
            { id: 6, name: 'ECR í‘¸ì‹œ', description: 'Amazon ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ', icon: 'â˜ï¸' },
            { id: 7, name: 'ECS ë°°í¬', description: 'ECS Fargateì— ë°°í¬', icon: 'ğŸš€' },
            { id: 8, name: 'Health Check', description: 'ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸', icon: 'ğŸ’š' },
        ];

        // ë°°í¬ ì‹œì‘ í™”ë©´
        function DeployStart({ onDeploy }) {
            const [repository, setRepository] = useState('');
            const [branch, setBranch] = useState('main');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (repository.trim()) {
                    onDeploy({ repository, branch });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="deploy-card max-w-2xl w-full">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2">
                                ìƒˆ ë°°í¬ ì‹œì‘
                            </h1>
                            <p className="text-gray-600">
                                Git Repositoryë¥¼ ì—°ê²°í•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³  ë°°í¬í•©ë‹ˆë‹¤
                            </p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ“¦ Repository URL ë˜ëŠ” ê²½ë¡œ
                                </label>
                                <input
                                    type="text"
                                    value={repository}
                                    onChange={(e) => setRepository(e.target.value)}
                                    placeholder="ì˜ˆ: test/scenario1 ë˜ëŠ” https://github.com/user/repo"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸŒ¿ Branch
                                </label>
                                <input
                                    type="text"
                                    value={branch}
                                    onChange={(e) => setBranch(e.target.value)}
                                    placeholder="main"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                            </div>

                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="text-sm font-semibold text-blue-900 mb-2">
                                    ğŸ’¡ ìë™ ë°°í¬ í”„ë¡œì„¸ìŠ¤
                                </h3>
                                <ul className="text-sm text-blue-800 space-y-1">
                                    <li>âœ“ AIê°€ ì½”ë“œë¥¼ ë¶„ì„í•˜ì—¬ í”„ë ˆì„ì›Œí¬ ê°ì§€</li>
                                    <li>âœ“ Dockerfileê³¼ ë°°í¬ ì„¤ì • ìë™ ìƒì„±</li>
                                    <li>âœ“ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ</li>
                                    <li>âœ“ ECS Fargateì— Blue-Green ë°°í¬</li>
                                    <li>âœ“ ìë™ Health Check ë° ë¡¤ë°±</li>
                                </ul>
                            </div>

                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl"
                            >
                                ğŸš€ ë°°í¬ ì‹œì‘í•˜ê¸°
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <a href="/" className="text-sm text-gray-600 hover:text-gray-900">
                                â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                            </a>
                        </div>
                    </div>
                </div>
            );
        }

        // ë°°í¬ ì§„í–‰ í™”ë©´
        function DeployProgress({ deploymentId, repository, branch }) {
            const [currentStep, setCurrentStep] = useState(1);
            const [completedSteps, setCompletedSteps] = useState([]);
            const [logs, setLogs] = useState([]);
            const [progress, setProgress] = useState(0);
            const [deploymentStatus, setDeploymentStatus] = useState('in_progress');
            const [error, setError] = useState(null);
            const logEndRef = useRef(null);

            useEffect(() => {
                // ìë™ ìŠ¤í¬ë¡¤
                if (logEndRef.current) {
                    logEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [logs]);

            useEffect(() => {
                // ì‹¤ì œ API í´ë§ ì‹œì‘
                startPollingDeploymentStatus();
            }, []);

            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString('ko-KR');
                setLogs(prev => [...prev, { message, type, timestamp }]);
            };

            const startPollingDeploymentStatus = async () => {
                try {
                    // 2ì´ˆë§ˆë‹¤ API í´ë§
                    const pollInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`api/deploy/${deploymentId}/status`);
                            const data = await response.json();

                            if (!data.success) {
                                throw new Error('Failed to fetch deployment status');
                            }

                            // ìƒíƒœ ì—…ë°ì´íŠ¸
                            setCurrentStep(data.current_step);
                            setProgress(data.progress);

                            // ì™„ë£Œëœ ë‹¨ê³„ ê³„ì‚°
                            const completed = [];
                            for (let i = 1; i <= data.current_step; i++) {
                                completed.push(i);
                            }
                            setCompletedSteps(completed);

                            // ë¡œê·¸ ì—…ë°ì´íŠ¸ (ìƒˆ ë¡œê·¸ë§Œ ì¶”ê°€)
                            if (data.logs && data.logs.length > logs.length) {
                                setLogs(data.logs);
                            }

                            // ìµœì¢… ìƒíƒœ í™•ì¸
                            if (data.status === 'success') {
                                setDeploymentStatus('success');
                                setProgress(100);
                                setCompletedSteps([1, 2, 3, 4, 5, 6, 7, 8]);
                                clearInterval(pollInterval);
                            } else if (data.status === 'failed') {
                                setDeploymentStatus('failed');
                                setError('Deployment failed');
                                clearInterval(pollInterval);
                            }

                        } catch (err) {
                            console.error('Polling error:', err);
                        }
                    }, 2000); // 2ì´ˆë§ˆë‹¤ í´ë§

                    // ìµœëŒ€ 30ë¶„ í›„ íƒ€ì„ì•„ì›ƒ
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        if (deploymentStatus === 'in_progress') {
                            setDeploymentStatus('failed');
                            setError('Deployment timeout (30 minutes)');
                        }
                    }, 1800000); // 30ë¶„

                } catch (err) {
                    setDeploymentStatus('failed');
                    setError(err.message);
                }
            };

            const getStepStatus = (stepId) => {
                if (completedSteps.includes(stepId)) return 'completed';
                if (stepId === currentStep) return 'active';
                if (deploymentStatus === 'failed' && stepId === currentStep) return 'error';
                return 'pending';
            };

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-6xl mx-auto">
                        {/* í—¤ë” */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">ë°°í¬ ì§„í–‰ ì¤‘</h1>
                                    <p className="text-gray-600 mt-1">
                                        {repository} ({branch})
                                    </p>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                                        {Math.round(progress)}%
                                    </div>
                                    <div className="text-sm text-gray-600 mt-1">
                                        {deploymentStatus === 'in_progress' && 'ë°°í¬ ì¤‘...'}
                                        {deploymentStatus === 'success' && 'âœ“ ì™„ë£Œ'}
                                        {deploymentStatus === 'failed' && 'âœ— ì‹¤íŒ¨'}
                                    </div>
                                </div>
                            </div>

                            {/* Progress Bar */}
                            <div className="progress-bar">
                                <div className="progress-fill" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>

                        {/* ë°°í¬ ë‹¨ê³„ */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-lg font-semibold text-gray-900 mb-6">ë°°í¬ ë‹¨ê³„</h2>
                            <div className="space-y-4">
                                {DEPLOY_STEPS.map((step, index) => {
                                    const status = getStepStatus(step.id);
                                    return (
                                        <div key={step.id} className="flex items-center">
                                            <div className={`step-item ${status}`}>
                                                {status === 'completed' && 'âœ“'}
                                                {status === 'active' && step.icon}
                                                {status === 'pending' && step.id}
                                                {status === 'error' && 'âœ—'}
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <div className="font-semibold text-gray-900">{step.name}</div>
                                                <div className="text-sm text-gray-600">{step.description}</div>
                                            </div>
                                            {status === 'active' && (
                                                <div className="text-sm text-purple-600 font-medium">ì§„í–‰ ì¤‘...</div>
                                            )}
                                            {status === 'completed' && (
                                                <div className="text-sm text-green-600 font-medium">ì™„ë£Œ</div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* ë¡œê·¸ ì½˜ì†” */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-lg font-semibold text-gray-900 mb-4">ë°°í¬ ë¡œê·¸</h2>
                            <div className="log-console">
                                {logs.map((log, index) => (
                                    <div key={index} className={`log-line log-${log.type}`}>
                                        <span className="text-gray-500">[{log.timestamp}]</span> {log.message}
                                    </div>
                                ))}
                                <div ref={logEndRef}></div>
                            </div>

                            {deploymentStatus === 'success' && (
                                <div className="mt-6 flex space-x-4">
                                    <a
                                        href="/"
                                        className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-semibold text-center hover:from-purple-700 hover:to-indigo-700 transition-all"
                                    >
                                        ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                                    </a>
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        ìƒˆ ë°°í¬ ì‹œì‘
                                    </button>
                                </div>
                            )}

                            {deploymentStatus === 'failed' && (
                                <div className="mt-6">
                                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                        <h3 className="text-red-900 font-semibold mb-2">ë°°í¬ ì‹¤íŒ¨</h3>
                                        <p className="text-red-700 text-sm">{error}</p>
                                    </div>
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-all"
                                    >
                                        ë‹¤ì‹œ ì‹œë„
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ë©”ì¸ ì•±
        function App() {
            const [isDeploying, setIsDeploying] = useState(false);
            const [deploymentInfo, setDeploymentInfo] = useState(null);
            const [deploymentId, setDeploymentId] = useState(null);

            const handleStartDeploy = async (info) => {
                try {
                    // ì‹¤ì œ API í˜¸ì¶œë¡œ ë°°í¬ ì‹œì‘
                    const response = await fetch('api/deploy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repository: info.repository,
                            branch: info.branch
                        })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to start deployment');
                    }

                    // ë°±ì—”ë“œì—ì„œ ë°›ì€ deployment_id ì‚¬ìš©
                    setDeploymentId(data.deployment_id);
                    setDeploymentInfo(info);
                    setIsDeploying(true);
                } catch (error) {
                    console.error('Failed to start deployment:', error);
                    alert('ë°°í¬ ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
                }
            };

            if (isDeploying && deploymentId) {
                return (
                    <DeployProgress
                        deploymentId={deploymentId}
                        repository={deploymentInfo.repository}
                        branch={deploymentInfo.branch}
                    />
                );
            }

            return <DeployStart onDeploy={handleStartDeploy} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
