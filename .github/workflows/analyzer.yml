name: Analyzer Lambda

on:
  workflow_dispatch:
    inputs:
      function_name:
        description: "Lambda function name"
        required: true
        default: "delightful-deploy-ai-analyzer"
      lambda_role_arn:
        description: "IAM role ARN for Lambda (required only on first create)"
        required: false
      invoke_after_deploy:
        description: "Invoke the Lambda once after update (true/false)"
        required: false
        default: "true"

env:
  AWS_REGION: ap-northeast-2
  ARTIFACTS_BUCKET: deplight-dev-artifacts-513348493870-apne2
  AI_ANALYSIS_TABLE: deplight-dev-ai-analysis

permissions:
  id-token: write
  contents: read

jobs:
  package-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_OIDC_ROLE || secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Package Lambda (zip)
        run: |
          set -euo pipefail
          LAMBDA_DIR="lambda/ai_code_analyzer"
          [ -d "$LAMBDA_DIR" ] || { echo "Missing directory: $LAMBDA_DIR"; exit 1; }
          mkdir -p build
          (cd "$LAMBDA_DIR" && zip -r ../../build/ai_analyzer.zip .)
          ls -la build

      - name: Ensure S3 bucket and DynamoDB table exist
        run: |
          set -euo pipefail
          BUCKET="${{ env.ARTIFACTS_BUCKET }}"
          REGION="${{ env.AWS_REGION }}"
          TABLE="${{ env.AI_ANALYSIS_TABLE }}"

          echo "Ensuring S3 bucket: $BUCKET"
          if ! aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET" --region "$REGION" --create-bucket-configuration LocationConstraint="$REGION"
            fi
          fi

          echo "Ensuring DynamoDB table: $TABLE"
          if ! aws dynamodb describe-table --table-name "$TABLE" --region "$REGION" >/dev/null 2>&1; then
            aws dynamodb create-table \
              --table-name "$TABLE" \
              --attribute-definitions AttributeName=analysis_id,AttributeType=S \
              --key-schema AttributeName=analysis_id,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region "$REGION"
            echo "Waiting for DynamoDB table to become active..."
            aws dynamodb wait table-exists --table-name "$TABLE" --region "$REGION"
          fi

      - name: Create or Update Lambda Function
        id: upsert
        env:
          FN: ${{ github.event.inputs.function_name }}
          ROLE_ARN: ${{ github.event.inputs.lambda_role_arn }}
        run: |
          set -euo pipefail
          ZIP="build/ai_analyzer.zip"
          if aws lambda get-function --function-name "$FN" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "Updating code for existing function: $FN"
            aws lambda update-function-code \
              --function-name "$FN" \
              --zip-file "fileb://$ZIP" \
              --region ${{ env.AWS_REGION }} >/dev/null
          else
            echo "Creating function: $FN"
            if [ -z "$ROLE_ARN" ]; then
              echo "lambda_role_arn is required for first-time create" >&2
              exit 1
            fi
            aws lambda create-function \
              --function-name "$FN" \
              --runtime python3.11 \
              --handler handler.lambda_handler \
              --timeout 900 \
              --memory-size 1024 \
              --role "$ROLE_ARN" \
              --zip-file "fileb://$ZIP" \
              --region ${{ env.AWS_REGION }} >/dev/null
          fi

          aws lambda wait function-updated \
            --function-name "$FN" \
            --region ${{ env.AWS_REGION }}
          echo "function-name=$FN" >> $GITHUB_OUTPUT

      - name: Update Lambda environment variables
        env:
          FN: ${{ steps.upsert.outputs.function-name }}
        run: |
          set -euo pipefail
          REGION="${{ env.AWS_REGION }}"
          BUCKET="${{ env.ARTIFACTS_BUCKET }}"
          TABLE="${{ env.AI_ANALYSIS_TABLE }}"

          # Fetch existing env vars and merge
          aws lambda get-function-configuration --function-name "$FN" --region "$REGION" --query 'Environment.Variables' --output json > env.json || echo '{}' > env.json
          jq --arg fn "$FN" --arg b "$BUCKET" --arg t "$TABLE" \
            '{FunctionName: $fn, Environment: {Variables: (. + {S3_BUCKET: $b, AI_ANALYSIS_TABLE: $t})}}' \
            env.json > cli_input.json
          aws lambda update-function-configuration --region "$REGION" --cli-input-json file://cli_input.json >/dev/null

      - name: Grant Lambda role access to S3/DynamoDB (dev-wide)
        env:
          FN: ${{ steps.upsert.outputs.function-name }}
        run: |
          set -euo pipefail
          REGION="${{ env.AWS_REGION }}"
          BUCKET="${{ env.ARTIFACTS_BUCKET }}"
          TABLE="${{ env.AI_ANALYSIS_TABLE }}"

          ROLE_ARN=$(aws lambda get-function-configuration --function-name "$FN" --region "$REGION" --query 'Role' --output text)
          ROLE_NAME=$(basename "$ROLE_ARN")
          POLICY_NAME="${ROLE_NAME}-ai-analyzer-access"

          cat > policy.json <<JSON
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": ["s3:PutObject", "s3:GetObject", "s3:ListBucket"],
                "Resource": [
                  "arn:aws:s3:::${BUCKET}",
                  "arn:aws:s3:::${BUCKET}/*"
                ]
              },
              {
                "Effect": "Allow",
                "Action": ["dynamodb:PutItem", "dynamodb:UpdateItem", "dynamodb:GetItem", "dynamodb:DescribeTable"],
                "Resource": "arn:aws:dynamodb:${REGION}:513348493870:table/${TABLE}"
              }
            ]
          }
          JSON

          aws iam put-role-policy \
            --role-name "$ROLE_NAME" \
            --policy-name "$POLICY_NAME" \
            --policy-document file://policy.json

      - name: Invoke Lambda (optional)
        if: ${{ github.event.inputs.invoke_after_deploy == 'true' }}
        env:
          FN: ${{ steps.upsert.outputs.function-name }}
        run: |
          set -euo pipefail
          echo '{}' > payload.json
          aws lambda invoke \
            --function-name "$FN" \
            --payload fileb://payload.json \
            --region ${{ env.AWS_REGION }} \
            response.json >/dev/null || true
          echo "Invocation response:"
          cat response.json || true
