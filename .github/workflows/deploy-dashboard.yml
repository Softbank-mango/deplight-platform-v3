name: Deploy Dashboard to ECS

on:
  # Temporarily disabled auto-trigger on push to avoid conflicts with Terraform
  # push:
  #   branches: [main]
  #   paths:
  #     - 'mango/dashboard/**'
  #     - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 513348493870.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: delightful-deploy
  ECS_CLUSTER: delightful-deploy-cluster
  ECS_SERVICE: delightful-deploy-dashboard-service

jobs:
  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get current ALB DNS
        id: alb
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names delightful-deploy-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          echo "alb_dns=${ALB_DNS}" >> $GITHUB_OUTPUT
          echo "ALB DNS: ${ALB_DNS}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="dashboard-${SHORT_SHA}"
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard
          file: ./dashboard/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image-tag }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:dashboard-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PORT=8000
            AWS_REGION=${{ env.AWS_REGION }}
            ALB_DNS=${{ steps.alb.outputs.alb_dns }}

      - name: Get current task definition
        id: task-def
        run: |
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].taskDefinition' \
            --output text)

          echo "task-def-arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT

          # Download task definition
          aws ecs describe-task-definition \
            --task-definition ${TASK_DEF_ARN} \
            --query 'taskDefinition' > task-def.json

      - name: Update task definition with new image
        id: new-task-def
        run: |
          # Remove unnecessary fields
          cat task-def.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > task-def-clean.json

          # Update container image
          NEW_IMAGE="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image-tag }}"

          cat task-def-clean.json | jq \
            --arg IMAGE "$NEW_IMAGE" \
            '.containerDefinitions[0].image = $IMAGE' > task-def-updated.json

          echo "Updated task definition with image: $NEW_IMAGE"
          cat task-def-updated.json | jq '.containerDefinitions[0].image'

      - name: Register new task definition
        id: register
        run: |
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def-updated.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "new-task-def-arn=${NEW_TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "Registered new task definition: ${NEW_TASK_DEF_ARN}"

      - name: Update ECS service
        run: |
          echo "Updating ECS service to use new task definition..."

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register.outputs.new-task-def-arn }} \
            --force-new-deployment

          echo "ECS service update initiated"

      - name: Wait for service stability
        run: |
          echo "Waiting for ECS service to stabilize (max 10 minutes)..."

          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}

          echo "âœ… Service is stable!"

      - name: Get deployment info
        id: deployment-info
        run: |
          SERVICE_INFO=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }})

          RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].runningCount')
          DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].desiredCount')

          echo "running-count=${RUNNING_COUNT}" >> $GITHUB_OUTPUT
          echo "desired-count=${DESIRED_COUNT}" >> $GITHUB_OUTPUT

          echo "Service Status:"
          echo "  Running tasks: ${RUNNING_COUNT}"
          echo "  Desired tasks: ${DESIRED_COUNT}"

      - name: Health check
        run: |
          ALB_DNS="${{ steps.alb.outputs.alb_dns }}"
          MAX_RETRIES=20
          RETRY_COUNT=0

          echo "Performing health check on http://${ALB_DNS}/api/health"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${ALB_DNS}/api/health" --max-time 10 || echo "000")

            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Health check passed! (HTTP $HTTP_CODE)"

              # Get health check response
              HEALTH_RESPONSE=$(curl -s "http://${ALB_DNS}/api/health")
              echo "Health check response: $HEALTH_RESPONSE"

              exit 0
            fi

            echo "Health check returned HTTP $HTTP_CODE, retrying..."
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 15
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Dashboard Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Task Definition:** \`${{ steps.register.outputs.new-task-def-arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ECS Cluster:** \`${{ env.ECS_CLUSTER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ECS Service:** \`${{ env.ECS_SERVICE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Running Tasks:** \`${{ steps.deployment-info.outputs.running-count }}/${{ steps.deployment-info.outputs.desired-count }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard URL:** http://${{ steps.alb.outputs.alb_dns }}/" >> $GITHUB_STEP_SUMMARY
          echo "**API Health:** http://${{ steps.alb.outputs.alb_dns }}/api/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
